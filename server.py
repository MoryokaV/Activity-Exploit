#!/usr/bin/env python3
import socket 
import sys
import os
from datetime import datetime

host = socket.gethostbyname("") 
port = 8080
sock = None

def create_server():
    try:
        global sock
        sock = socket.socket()
        print("Server started on " + host)
    except socket.error as msg:
        print("Socket Creation ERROR: " + str(msg))

def bind_socket():
    try:
        print("Binding the Port " + str(port))
        print("Waiting for client...")

        sock.bind((host, port))
        sock.listen(5)
    except socket.error as msg:
        print("Socket Binding error " + str(msg) + "\n" + "Retrying...")
        bind_socket()

def socket_accept():
    conn, addr = sock.accept()
    print("Connection has been established! | " + " IP " + addr[0] + " | Port " + str(addr[1]))
    send_commands(conn)

def send_commands(conn):
    cmd = input("Take Screenshot? 1 / 0: ")

    if cmd == "1":
        conn.send(cmd.encode())
        download_file(conn)
    else:
        conn.send(cmd.encode())
        sock.close()
        sys.exit() 

def download_file(conn):
    print("\nColecting Screenshot...")
    data = conn.recv(1024)
    filesize = data.decode()

    date = datetime.now()
    str_date = date.strftime("%d-%m-%Y %H'%M'%S")

    filename = "Screenshot_" + str_date    
    path = filename + ".png"

    print("Creating File...Alocating memory...")

    f = open(filename + ".png", 'wb')

    data = conn.recv(1024)
    totalRecv = len(data)
    f.write(data)
    
    while totalRecv < float(filesize):
        data = conn.recv(1024)
        totalRecv += len(data)
        f.write(data)
        print("{0:.2f}".format((totalRecv/float(filesize)) * 100) + \
                "% Done...", end = "\r")
        conn.send("Downloading".encode('utf-8'))

    print("\nScreenshot received!\n")
    conn.send("Download Finished!".encode('utf-8'))
    send_commands(conn)

if __name__ == '__main__':
    create_server()
    bind_socket()
    socket_accept()
